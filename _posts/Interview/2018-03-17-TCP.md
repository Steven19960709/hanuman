---
layout: post
title: TCP协议
tags: [Interview,network]
---

这几天国庆假期，真的没有让自己停下来。。。都不知道自己怎样想的。。。明明是放假，就是不出去玩。。是我太懒了吗？？

于是我就找了一些坑一个一个填。今天就讲一下TCP协议的相关知识。

# Internet Introduction

互联网是由一整套协议构成的，TCP是其中的一个协议，有着自己的分工。

<img src="http://s8.51cto.com/wyfs02/M00/52/1F/wKiom1RkCCWTa_RqAAJf_qGuyAU502.jpg-wh_651x-s_1754659787.jpg">

    OSI参考模型：
    1.物理层---2.数据链路层---3.网络层---4.运输层---5.会话层---6.表示层---7.应用层
    TCP/IP参考模型：
    网络接口层---网络层IP---运输层（TCP或UDP）---应用层（各种应用层协议如：TELNET，FTP，SMTP等）

TCP/IP 协议族按照层次由上到下，层层包装。

##### 应用层：

向用户提供一组常用的应用程序，远程登录TELNET使用TELNET协议提供在网络其他注意注册的接口。TELNET绘画提供基于字符的虚拟终端。文件传输访问FTP使用FTP协议来提供网络内机器间的文件拷贝功能。

##### 传输层：

提供应用程序间的通信。包括：

- 格式化信息流
- 提供可靠传输（传输层协议规定接收端必须发回确认，并且加入分组丢失，必须重新发送。

##### 网络层：

负责相邻计算机之间的通信。功能包括：

- 处理来自传输层发送的分组发送请求，收到请求后，将分组装入IP数据包，填充报头，选择去往信宿机，然后将数据发往适当的网络接口
- 处理数据报，首先检查器合法性，然后进行寻址；
- 处理路径，流控，拥塞等问题。

##### 网络接口层：

负责接收IP数据报并通过网络发送，或者从网络上接收物理帧，抽出IP数据报，交给IP层。

<img src="http://ovk2ylefr.bkt.clouddn.com/tcp.png">

<img src="http://s8.51cto.com/wyfs02/M01/52/1F/wKiom1RkCD2DRJ_lAAIRCC8B-nU958.jpg">


IP(网络层）协议定义了一套自己的地址规则，称为IP地址。它实现了路由功能，允许某个局域网的A主机，向另外一个局域网的B主机发送消息。

但是IP协议只是一个地址协议，并不能保证数据包的完整，如果路由去丢包（例如缓存满，新进来的数据包就会丢失）。这个时候就需要发现丢了哪一个包，以及入股重新发送这个包，于是就要靠TCP协议了。

简单说，TCP 协议的作用是，保证数据通信的完整性和可靠性，防止丢包。

# TCP Introduction

TCP(Transmission Control Protocol 传输控制协议)是一种面向连接(连接导向)的、可靠的、 基于IP的传输层协议。TCP在IP报文的协议号是6。

## 重要字段

<img src="http://ovk2ylefr.bkt.clouddn.com/TCP2.png">

这张图听说是十分重要的，我就挑我感觉很重要的字段讲一讲。

- Source Port（源端口）和Destination Port（目的端口）

分别占用16位，表示源端口号和目的端口号;用于区别主机中的不同进程， 而IP地址是用来区分不同的主机的，源端口号和目的端口号配合上IP首部中的源IP地址和目的IP地址就能唯一 的确定一个TCP连接;

- Sequence Number（序号）:

用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个报文段中的的第一个数据 字节在数据流中的序号;主要用来解决网络报乱序的问题;

- Acknowledgment Number（确认序号）

32位确认序列号包含发送确认的一端所期望收到的下一个序号，因此，确认序号应 当是上次已成功收到数据字节序号加1。不过，只有当标志位中的ACK标志(下面介绍)为1时该确认序列号的字 段才有效。主要用来解决不丢包的问题;

- TCP Flags:TCP首部中有6个标志比特，它们中的多个可同时被设置为1，主要是用于操控TCP的状态机的，依次 为URG，ACK，PSH，RST，SYN，FIN。我就说一下ACK，这个听得很多。

ACK: 这个标志表示应答域有效，就是说前面所说的TCP应答好将会包含在TCP数据包中，有两个取值，0和1，1表示有效，0无效。

SYN：表示同步序号，用来建立连接。SYN标志位和ACK标志位搭配使用，当连接请求的时候，SYN=1， ACK=0;连接被响应的时候，SYN=1，ACK=1;这个标志的数据包经常被用来进行端口扫描。扫描者发送 一个只有SYN的数据包，如果对方主机响应了一个数据包回来 ，就表明这台主机存在这个端口;但是由于这 种扫描方式只是进行TCP三次握手的第一次握手，因此这种扫描的成功表示被扫描的机器不很安全，一台安全 的主机将会强制要求一个连接严格的进行TCP的三次握手;

## 三次握手

这个毋庸多说，肯定是很重要的，面试分分钟会问到。下面就讲一讲（虽然之前已经讲过，但是忘了）

TCP是面向连接的，无论数据传输方向是哪，都必须现在双方之间建立一个连接。在TCP/IP协议中，TCP提过可靠的连接服务，连接是通过三次握手来进行初始化的。目的是同步连接双方的序列号和确认号并交换TCP窗口大小信息。但是在面试中你答这样是远远不足够获取大厂offer的。需要理解一下细节。

<img src="http://s9.51cto.com/wyfs02/M00/52/1F/wKiom1RkCGyDnmDKAARlVYJdLnE985.jpg">

第一次握手，client端，把SYN置为1，并随机获取一个seq序号J，发送到server端，client端进入SYN_SEND状态。

第二次握手，server通过检查SYN是否为1，得知，client请求连接，然后，他将SYN和ACK都置为一，并且，向client端发送一个ack=J+1，和随机获取的一个seq，K。server进入SYN_REVD

第三次握手，client检查ack是否为J+1，ACK是否为1，之后确认无误，它将ack=K+1返回给SERVER端，server检查ack是否为K+1，确认无误，连接成功，两者进入ESTABLESHED状态，完成三次握手，开始传输数据。

完成了三次握手，客户端和服务器端就可以开始传送数据。以上就是TCP三次握手的总体介绍。

### 三次握手的原因

为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。

## 四次挥手

由于TCP连接是全双工的，因此每个方向都必须单独进行关闭。这原则是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向的连接。收到一个 FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。

<img src="http://outu8mec9.bkt.clouddn.com/tcp3.jpg">

过程如下：

（1） TCP客户端发送一个FIN，用来关闭客户到服务器的数据传送。

（2） 服务器收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。和SYN一样，一个FIN将占用一个序号。 

（3） 服务器关闭客户端的连接，发送一个FIN给客户端。

（4） 客户端发回ACK报文确认，并将确认序号设置为收到序号加1。

### 挥手的原因

TCP连接是全双工的
即数据可在两个方向上同时传递)所以进行关闭时每个方向上都要单独进行关闭,这个单方向的关闭就叫半关闭.
关闭的方法是一方完成它的数据传输后,就发送一个FIN来向另一方通告将要终止这个方向的连接.当一端收到一个FIN,它必须
通知应用层TCP连接已终止了这个方向的数据传送,发送FIN通常是应用层进行关闭的结果.


## IP协议


IP协议用于计算机之间的通信。它是无连接的通信协议，不会占用正在通信的计算机之间的通信线路。

网络上的每一个节点都必须有一个独立的Internet地址（也叫作IP地址）。现在通常使用的IP地址是一个32比特的数字，也就是我们常说的<strong>IP标准</strong>，这32bit的数字分成四组，也就是常见的255.255.255.255的样式。IPv4标准上，地址被分为5类，ABCDE ,5类，使用类型分别为大型网络，中型网络，小型网络，夺目网络，备用。

### IP 地址

每台主机都有一个唯一的IP地址。IP协议就是使用这个地址在主机之间传递信息，这时Internet能够运行的基础。IP地址长度为32位，分为四段，每段8位，十进制表示，每段范围0~255。有两部分构成，网络标识号码和主机标识号码，即网络地址+主机地址。

#### IP地址类型

私有地址（Private address）属于非注册地址，专门为组织机构内部使用。

<div class="table" style="display:flex;background:;font-size:12px;">
<div style='border:1px solid #ccc; flex-grow:1'class="head">类别
<div class="row">A</div>
<div class="row">B</div>
<div class="row">C</div>
</div>
<div style='border:1px solid #ccc; flex-grow:1'class="head">最大网络数
<div class="row">126</div>
<div class="row">16384</div>
<div class="row">2097152</div>
</div>
<div style='border:1px solid #ccc; flex-grow:1'class="head">IP地址范围
<div class="row">0.0.0.0-127.255.255.255</div>
<div class="row">128.0.0.0-191.255.255.255</div>
<div class="row">192.0.0.0-223.255.255.255</div>
<div class="row"></div>
</div>
<div style='border:1px solid #ccc; flex-grow:1'class="head">最大主机数
<div class="row">16777214</div>
<div class="row">65534</div>
<div class="row">254</div>
</div>
<div style='border:1px solid #ccc; flex-grow:1'class="head">私有IP地址范围
<div class="row">10.0.0.0-10.255.255.255</div>
<div class="row">172.16.0.0-172.31.255.255</div>
<div class="row">192.18.0.0-192.168.255.255</div>
</div>
</div>

还有D类IP地址，被叫做多播地址，即组播地址，在以太网中，多播地址命名了一组应该在这个网络中应用接收到一个分组的站点。

特殊的网址：

- 每一个字节都为0的地址（“0.0.0.0”）对应于当前主机；
- IP地址中的每一个字节都为1的IP地址（“255．255．255．255”）是当前子网的广播地址；
- IP地址中凡是以“11110”开头的E类IP地址都保留用于将来和实验使用。
- IP地址中不能以十进制“127”作为开头，该类地址中数字127．0．0．1到127．255．255．255用于回路测试，如：127.0.0.1可以代表本机IP地址，用“http://127.0.0.1”就可以测试本机中配置的Web服务器。
- 网络ID的第一个8位组也不能全置为“0”，全“0”表示本地网络。

[详细知识](https://baike.baidu.com/item/IP%E5%9C%B0%E5%9D%80/150859?fr=aladdin)

## TCP/IP 

TCP/IP 意味着 TCP 和 IP 在一起协同工作。

TCP 负责应用软件（比如你的浏览器）和网络软件之间的通信。

IP 负责计算机之间的通信。

TCP 负责将数据分割并装入 IP 包，然后在它们到达的时候重新组合它们。

IP 负责将包发送至接受者。












那么今天的内容就讲到这里，希望大家能有所收获。